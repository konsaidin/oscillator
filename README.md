# ⚡ Трёхфазный монитор напряжения на ESP32-S3

[![PlatformIO](https://img.shields.io/badge/PlatformIO-ESP32--S3-orange)](https://platformio.org/)
[![License](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)

## 📋 Обзор проекта

Система мониторинга трёхфазной электросети (380В/220В) на базе микроконтроллера **ESP32-S3** и трёх датчиков напряжения **ZMPT101B**. Устройство измеряет параметры сети в реальном времени, анализирует качество электроэнергии и предоставляет данные через веб-интерфейс с обновлением по WebSocket.

### 🎯 Основные функции

| Функция | Описание |
|---------|----------|
| **📊 Измерение напряжения** | RMS напряжение каждой фазы (A, B, C) |
| **📈 Междуфазное напряжение** | Линейные напряжения AB, BC, CA |
| **🔄 Частота сети** | Измерение частоты 50/60 Гц методом Zero-Crossing |
| **⚖️ Перекос фаз** | Расчёт несимметрии напряжений (%) |
| **🚨 Детекция проблем** | Обрыв фазы, превышение/занижение напряжения |
| **🌐 Real-time веб-интерфейс** | Графики и индикаторы через WebSocket |

---

## 🛠 Технический стек

### Аппаратное обеспечение

| Компонент | Модель | Назначение |
|-----------|--------|------------|
| **MCU** | ESP32-S3-DevKitC-1 | Двухъядерный процессор 240 МГц, WiFi, 12-бит ADC |
| **Датчики** | ZMPT101B × 3 | Трансформаторные датчики напряжения с гальванической развязкой |
| **Питание** | 5V DC (USB-C) | Питание контроллера и датчиков |

### Программный стек

```
┌─────────────────────────────────────────────────────────────┐
│                      FIRMWARE (ESP32-S3)                    │
├─────────────────────────────────────────────────────────────┤
│  Framework: Arduino + ESP-IDF                               │
│  Platform:  PlatformIO                                      │
├─────────────────────────────────────────────────────────────┤
│                       БИБЛИОТЕКИ                            │
├──────────────────┬──────────────────────────────────────────┤
│ ESPAsyncWebServer│ Асинхронный HTTP/WebSocket сервер        │
│ ArduinoJson      │ Сериализация данных в JSON               │
│ LittleFS         │ Файловая система для веб-файлов          │
│ Preferences      │ Хранение настроек калибровки             │
├──────────────────┴──────────────────────────────────────────┤
│                      FRONTEND                               │
├─────────────────────────────────────────────────────────────┤
│  HTML5 + CSS3 (Grid/Flexbox)                                │
│  JavaScript (ES6+, WebSocket API)                           │
│  Chart.js — графики в реальном времени                      │
└─────────────────────────────────────────────────────────────┘
```

### Почему выбран этот стек?

| Технология | Почему |
|------------|--------|
| **WebSocket** | Двунаправленная связь, низкая задержка (<50ms), идеально для real-time данных |
| **ESPAsyncWebServer** | Неблокирующий сервер, поддержка WebSocket из коробки |
| **Chart.js** | Лёгкая библиотека (~60KB), hardware-accelerated canvas, real-time обновление |
| **LittleFS** | Wear-leveling, надёжнее SPIFFS, поддержка директорий |

---

## 📐 Архитектура системы

### Схема потоков данных

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   Сеть 380В  │     │   Сеть 380В  │     │   Сеть 380В  │
│    Фаза A    │     │    Фаза B    │     │    Фаза C    │
└──────┬───────┘     └──────┬───────┘     └──────┬───────┘
       │                    │                    │
       ▼                    ▼                    ▼
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  ZMPT101B #1 │     │  ZMPT101B #2 │     │  ZMPT101B #3 │
│  (изоляция)  │     │  (изоляция)  │     │  (изоляция)  │
└──────┬───────┘     └──────┬───────┘     └──────┬───────┘
       │ 0-3.3V             │ 0-3.3V             │ 0-3.3V
       ▼                    ▼                    ▼
┌─────────────────────────────────────────────────────────┐
│                      ESP32-S3                           │
│  ┌───────────────────────────────────────────────────┐  │
│  │              ADC1 (12-bit, 10kHz)                 │  │
│  │         GPIO1      GPIO2      GPIO3               │  │
│  └───────────────────────┬───────────────────────────┘  │
│                          │                              │
│  ┌───────────────────────▼───────────────────────────┐  │
│  │            Signal Processing Task                 │  │
│  │  • RMS Calculation (N samples per period)         │  │
│  │  • Zero-Crossing Frequency Detection              │  │
│  │  • Unbalance & Anomaly Detection                  │  │
│  └───────────────────────┬───────────────────────────┘  │
│                          │                              │
│  ┌───────────────────────▼───────────────────────────┐  │
│  │              WebSocket Server (:80/ws)            │  │
│  │           JSON @ 1-10 updates/sec                 │  │
│  └───────────────────────┬───────────────────────────┘  │
└──────────────────────────┼──────────────────────────────┘
                           │ WiFi
                           ▼
                    ┌──────────────┐
                    │   Browser    │
                    │  Dashboard   │
                    │  (Chart.js)  │
                    └──────────────┘
```

### Схема подключения (Pinout)

| Компонент | Пин ESP32-S3 | Функция | Примечание |
|-----------|--------------|---------|------------|
| **ZMPT101B (Фаза A)** | GPIO 1 | ADC1_CH0 | Аттенюация 11dB |
| **ZMPT101B (Фаза B)** | GPIO 2 | ADC1_CH1 | Аттенюация 11dB |
| **ZMPT101B (Фаза C)** | GPIO 3 | ADC1_CH2 | Аттенюация 11dB |
| **OLED SDA (опц.)** | GPIO 8 | I2C SDA | SSD1306 128x64 |
| **OLED SCL (опц.)** | GPIO 9 | I2C SCL | — |
| **Status LED** | GPIO 48 | Встроенный LED | Индикация работы |

> ⚠️ **Важно**: Используйте только **ADC1** (GPIO 1-10). ADC2 конфликтует с WiFi!

---

## 🧮 Математическая модель

### 1. RMS напряжение (действующее значение)

$$U_{RMS} = \sqrt{\frac{1}{N} \sum_{i=1}^{N} (u_i - u_{offset})^2} \times K_{cal}$$

| Параметр | Описание |
|----------|----------|
| $u_i$ | i-й отсчёт АЦП |
| $u_{offset}$ | Смещение нуля (≈ VCC/2 = 1.65V = ~2048 для 12-бит) |
| $N$ | Количество отсчётов (рекомендуется 200+ на период) |
| $K_{cal}$ | Калибровочный коэффициент (зависит от датчика) |

### 2. Междуфазное (линейное) напряжение

Для симметричной трёхфазной системы со сдвигом 120°:

$$U_{line} = U_{phase} \times \sqrt{3} \approx U_{phase} \times 1.732$$

Пример: $U_{phase} = 220V \Rightarrow U_{line} = 380V$

### 3. Частота сети (Zero-Crossing)

$$f = \frac{N_{crossings}}{2 \times T_{measurement}}$$

Алгоритм:
1. Детектируем переход сигнала через $u_{offset}$
2. Засекаем время между переходами
3. Усредняем за 10-20 периодов

### 4. Перекос фаз (Voltage Unbalance)

По стандарту **NEMA MG-1**:

$$Unbalance (\%) = \frac{\max(|U_A - U_{avg}|, |U_B - U_{avg}|, |U_C - U_{avg}|)}{U_{avg}} \times 100$$

| Значение | Состояние |
|----------|-----------|
| 0-2% | ✅ Норма |
| 2-4% | ⚠️ Допустимо |
| >4% | 🔴 Проблема |

---

## 🌐 Протокол обмена данными

### WebSocket JSON формат

Сервер отправляет JSON каждые **100-1000 мс**:

```json
{
  "phaseA": { "voltage": 221.5, "status": "ok" },
  "phaseB": { "voltage": 219.8, "status": "ok" },
  "phaseC": { "voltage": 223.1, "status": "ok" },
  "line": { "AB": 383.5, "BC": 380.2, "CA": 386.1 },
  "frequency": 50.02,
  "unbalance": 1.23,
  "alerts": {
    "phaseLoss": false,
    "overVoltage": false,
    "underVoltage": false,
    "unbalance": false
  },
  "timestamp": 1703419200000
}
```

### REST API

| Endpoint | Метод | Описание |
|----------|-------|----------|
| `/` | GET | Веб-интерфейс (HTML) |
| `/api/status` | GET | Текущие показания (JSON) |
| `/api/config` | GET/POST | Настройки калибровки |
| `/ws` | WebSocket | Real-time данные |

---

## 📁 Структура проекта

```
oscillator/
├── platformio.ini          # Конфигурация PlatformIO
├── README.md               # Документация (этот файл)
├── TODO.md                 # План разработки
│
├── src/
│   ├── main.cpp            # Точка входа, инициализация
│   ├── config.h            # Конфигурация (пины, WiFi, пороги)
│   ├── VoltageSensor.h/cpp # Класс работы с ZMPT101B
│   └── PowerAnalyzer.h/cpp # Анализ трёхфазной сети
│
└── data/                   # Веб-интерфейс (LittleFS)
    ├── index.html          # Главная страница
    ├── style.css           # Стили
    └── script.js           # WebSocket клиент + Chart.js
```

---

## 🚀 Быстрый старт

### 1. Клонирование и настройка

```bash
git clone https://github.com/konsaidin/oscillator.git
cd oscillator
```

### 2. Конфигурация WiFi

Отредактируйте `src/config.h`:

```cpp
#define WIFI_SSID "YOUR_WIFI_SSID"
#define WIFI_PASS "YOUR_WIFI_PASSWORD"
```

### 3. Сборка и загрузка

```bash
# Компиляция прошивки
pio run

# Загрузка прошивки
pio run -t upload

# Загрузка веб-интерфейса в LittleFS
pio run -t uploadfs
```

### 4. Подключение к устройству

1. Откройте Serial Monitor (`pio device monitor`)
2. Найдите IP-адрес устройства в логе
3. Откройте `http://<IP_ADDRESS>` в браузере

---

## ⚠️ Требования безопасности

| ⚡ ВНИМАНИЕ: Работа с высоким напряжением опасна для жизни! |
|:---:|

1. **Гальваническая развязка**: ZMPT101B обеспечивает изоляцию, но соблюдайте осторожность при монтаже высоковольтной части.

2. **Корпус**: Устройство должно быть в **диэлектрическом корпусе** класса защиты не ниже IP20.

3. **Предохранители**: Обязательно установите плавкие вставки **0.5A** на входе каждой фазы перед датчиком.

4. **Заземление**: Корпус устройства должен быть заземлён.

5. **Квалификация**: Монтаж должен выполнять **квалифицированный электрик**.

---

## 📜 Лицензия

MIT License — свободное использование с указанием авторства.

---

## 📖 Дополнительно

- [TODO.md](TODO.md) — План разработки и задачи
- [Datasheet ZMPT101B](https://www.google.com/search?q=ZMPT101B+datasheet)
- [ESP32-S3 Technical Reference](https://www.espressif.com/en/products/socs/esp32-s3)
